# リポジトリガイドライン

## AIエージェントとの協業方針

- このリポジトリは Rust / TanStack Start 学習を主目的とし、実装の主体はユーザー（実装者）とする。
- AIエージェントは原則としてレビュー担当とし、コードの問題点・改善点・リスクを指摘する。
- AIエージェントは、ユーザーから明示的に依頼された場合に限り、部分的な実装や修正を行う。
- 実装依頼がない場合は、設計相談、実装方針の提案、レビューコメント、学習のための解説を優先する。

## 運用ドキュメント

- 引き継ぎメモ（継続運用）: `docs/agent-handover-template.md`

## 使用言語

- ドキュメントには日本語を使用し、コード内のコメントも日本語で記述。
- コード内の変数名、関数名、構造体名などは英語で記述。
- ただし、以下のように何らかのツールにより自動生成されたコードに関しては、上記ルールに反してもそれを許容する。

  ```rust
  //! `SeaORM` Entity, @generated by sea-orm-codegen 1.1.17
  ```

## プロジェクト構成とモジュール構成

- `backend/` は Rust バックエンドのルート（Cargo ワークスペース兼ルートパッケージ）。
    - `src/` は API サーバのエントリポイント。
    - `crates/` はワークスペースのクレート群:
        - `crates/presentation/` HTTP ルーティングとリクエスト/レスポンスモデル。
        - `crates/use-case/` アプリケーション/サービス層、プレゼンテーションとのインタフェース。
        - `crates/domain/` ドメインとリポジトリのインターフェース。
        - `crates/infra-db/` SeaORM のエンティティ、リポジトリ、DB 接続補助。
        - `crates/infra-db-migration/` SeaORM のマイグレーション CLI とファイル群。
- `frontend/` はフロントエンド関連のソース。
- `docker/` は開発用コンテナと本番用コンテナ
    - `backend` は本番用バックエンド。
    - `backend-dev` は開発用バックエンド。
- `init/` は初期化スクリプト群。

## backend

### ビルド・テスト・開発コマンド

- `docker compose up -d` で PostgreSQL を起動し、マイグレーション、APIサーバを起動。
- `cd backend && cargo run` で API サーバを起動（`BIND_ADDR:BIND_PORT` にバインド）。
- `cd backend && cargo test` でワークスペース全体のテストを実行（存在する場合）。
- `cd backend && cargo run -p infra-db-migration -- status` でマイグレーションの状態確認。
- `cd backend && cargo run -p infra-db-migration -- up` で未適用マイグレーションを適用。

### コーディングスタイルと命名規則

- 標準の Rust フォーマットに従い、`cargo fmt` を実行（`rust-toolchain.toml` に rustfmt あり）。
- 命名は Rust の慣例に従う: 関数/モジュールは `snake_case`、型は `CamelCase`。
- 説明や解説は日本語で記述し、コード上の変数名・関数名・構造体名などは英語で記述する。
- レイヤ構成（presentation/use-case/domain/infra）に沿って責務と境界を保つ。

### テスト指針

- `backend/` 配下で `cargo test` を実行。
- テストは対象コードの近くに配置（例: `backend/crates/*/src/`）。
- DB 依存テストを追加する場合は、必要な環境変数と手順を記載。

## frontend

- frontend の採用フレームワークは TanStack Start で確定とし、学習目的で SSR とデータ取得フローを優先して学ぶ。
- TanStack Start は RC を含むため、学習用途として破壊的変更の追従コストを許容する前提で扱う。
- Rust バックエンド（`backend/`）との連携を前提にし、API 呼び出しは `frontend/` 側でクライアント層を分離して実装する。
- ベンダーロックインを下げるため、フレームワーク固有機能への依存を最小化し、移行しやすい構成を意識する。
- まずは 2 週間のスパイク実装で適合性を確認し、追従コストが高い場合は Next.js への切り替えを再評価する。

### ビルド・テスト・開発コマンド

- `cd frontend && pnpm install` で依存関係をインストール。
- `cd frontend && pnpm run dev` で開発サーバを起動。
- `cd frontend && pnpm run build` で本番ビルドを作成。
- `cd frontend && pnpm run test` でテストを実行。
- frontend の package manager は `pnpm` に統一し、`npm` / `yarn` を混在させない。
- `pnpm-lock.yaml` を lockfile として管理する。
- Node / `pnpm` のバージョン番号は `AGENTS.md` に固定値を書かず、`frontend/package.json`（`engines` / `packageManager`）と `pnpm` 設定（例: `frontend/.npmrc`）を参照する。

### コーディングスタイルと命名規則

- TypeScript を前提とし、型安全性を優先する（`any` の常用を避ける）。
- 命名は React/TypeScript 慣例に従う:
    - コンポーネント名は `PascalCase`。
    - 関数・変数名は `camelCase`。
    - カスタムフック名は `useXxx`。
- API クライアント層を分離し、UI から直接 `fetch` 実装を重複させない。
- 説明や解説は日本語で記述し、コード上の識別子は英語で記述する。

### テスト指針

- 単体テストを優先し、ロジック（変換・バリデーション・ユーティリティ）をテスト対象にする。
- 重要画面は最小限の統合テストを追加し、SSR 初期表示と API 連携の回帰を検知できるようにする。
- テストの実行方法と前提条件（必要な環境変数など）を `frontend/` 配下の README に明記する。

## コミットとプルリクエストの指針

- コミットメッセージはスコープ付きプレフィックス形式（例: `[infra] Add migration files`）。
- 1 コミット 1 変更（または 1 レイヤ）を意識。
- PR には要約、実行したコマンド（`cargo test`、マイグレーション）、DB スキーマ変更の有無を記載。

## 設定と環境

- backend 想定環境変数:
    - `BIND_ADDR`, `BIND_PORT`, `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_OPERATOR_NAME`, `DB_OPERATOR_PASSWORD`
- frontend 想定環境変数:
    - API ベース URL（命名は TanStack Start 導入時に確定し、本ファイルへ追記する）
- 秘密情報はローカルの `.env` であり、リポジトリにコミット済みの `.env` は開発用のサンプル。
- ツールのバージョン制約（Node / `pnpm`）は `frontend/package.json` と `frontend/.npmrc` を参照する。
